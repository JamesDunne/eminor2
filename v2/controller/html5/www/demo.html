<!DOCTYPE html>

<html>
<head>
<script type="text/javascript" src="eminorv2.js"></script>
<style type="text/css">
body { background: #777; color: silver; }
</style>
</head>
<body>
    <canvas id="cvs"></canvas>

<script type="text/javascript">
"use strict";

function hex1(v) {
    var h = v.toString(16).toUpperCase();
    return (h).substring(0, 1);
}
function hex2(v) {
    var h = v.toString(16).toUpperCase();
    return ("00" + h).substring(h.length);
}

// Global state:
var ui_modified = false;
var fsw_state = 0;
var led_state_top = 0;
var led_state_bot = 0;

// MIDI controller "hardware" interface:

// poll all 16 foot switches' state in a 16-bit word:
function _fsw_poll() { return fsw_state; }
// called to set the new state of the LEDs in a top and bottom row, each 8-bit words:
function _led_set(top, bot) {
    if (led_state_top != top) ui_modified = true;
    if (led_state_bot != bot) ui_modified = true;

    led_state_top = top;
    led_state_bot = bot;

    console.log("top: %d, bot: %d", top, bot);
}
// called to send MIDI command with one data byte:
function _midi_send_cmd1(cmd, chan, data1) {
    console.log("MIDI: %s%s %s", hex1(cmd), hex1(chan), hex2(data1));
}
// called to send MIDI command with two data bytes:
function _midi_send_cmd2(cmd, chan, data1, data2) {
    console.log("MIDI: %s%s %s %s", hex1(cmd), hex1(chan), hex2(data1), hex2(data2));
}


// ----------------- UI

var cvs, ctx;
var dpi = 55.4;

// Total width, height in inches:
var inWidth = 20.0;
var inHeight = 7.0;

// Position and spacing of footswitches (from centers):
var vStart = 2.5;
var hLeft = 1.0;
var hSpacing = 2.57;
var vSpacing = 3.15;

// was 0.2032
var inLEDOuterDiam = (8 /*mm*/ * 0.01 * 2.54);

// was 0.34026
var inFswOuterDiam = (12.2 /*mm*/ * 0.01 * 2.54);
// was 0.30
var inFswInnerDiam = (11 /*mm*/ * 0.01 * 2.54);

function dpi_MoveTo(X, Y) {
    ctx.moveTo(X * dpi, Y * dpi);
}

function dpi_LineTo(X, Y) {
    ctx.lineTo(X * dpi, Y * dpi);
}

function dpi_CenterEllipse(cX, cY, rW, rH) {
    ctx.arc(cX * dpi, cY * dpi, rW * dpi, 0, 2*Math.PI);
}

function dpi_TextOut(nXStart, nYStart, lpString) {
    ctx.strokeText(lpString, nXStart * dpi, nYStart * dpi);
}

function renderUI() {
    ctx.save();
    ctx.clearRect(0, 0, cvs.width, cvs.height);

    var h, inH, v, inV;

    // draw grid:
    ctx.strokeStyle = "#202020";
    h = 0;
    for (inH = 0; inH <= inWidth; inH += 0.1, h = (h + 1) % 10) {
        if (h == 0) {
            ctx.lineWidth = 2;
        } else {
            ctx.lineWidth = 1;
        }
        ctx.beginPath();
        dpi_MoveTo(inH, 0);
        dpi_LineTo(inH, inHeight);
        ctx.stroke();

        v = 0;
        for (inV = 0; inV <= inHeight; inV += 0.1, v = (v + 1) % 10) {
            if (v == 0) {
                ctx.lineWidth = 2;
            } else {
                ctx.lineWidth = 1;
            }
            ctx.beginPath();
            dpi_MoveTo(0, inV);
            dpi_LineTo(inWidth, inV);
            ctx.stroke();
        }
    }

    

    ctx.restore();
}

function keydown(e) {
    //console.log(e);
    // QWERTYUI for top row:
    if (e.keyCode == 81) fsw_state |= 1;
    else if (e.keyCode == 87) fsw_state |= 2;
    else if (e.keyCode == 69) fsw_state |= 4;
    else if (e.keyCode == 82) fsw_state |= 8;
    else if (e.keyCode == 84) fsw_state |= 16;
    else if (e.keyCode == 89) fsw_state |= 32;
    else if (e.keyCode == 85) fsw_state |= 64;
    else if (e.keyCode == 73) fsw_state |= 128;
    // ASDFGHJK for bottom row:
    else if (e.keyCode == 65) fsw_state |= 256;
    else if (e.keyCode == 83) fsw_state |= 512;
    else if (e.keyCode == 68) fsw_state |= 1024;
    else if (e.keyCode == 70) fsw_state |= 2048;
    else if (e.keyCode == 71) fsw_state |= 4096;
    else if (e.keyCode == 72) fsw_state |= 8192;
    else if (e.keyCode == 74) fsw_state |= 16384;
    else if (e.keyCode == 75) fsw_state |= 32768;
    else return true;

    e.preventDefault();
    return false;
}

function keyup(e) {
    //console.log(e);
    // QWERTYUI for top row:
    if (e.keyCode == 81) fsw_state &= 1 ^ 65535;
    else if (e.keyCode == 87) fsw_state &= 2 ^ 65535;
    else if (e.keyCode == 69) fsw_state &= 4 ^ 65535;
    else if (e.keyCode == 82) fsw_state &= 8 ^ 65535;
    else if (e.keyCode == 84) fsw_state &= 16 ^ 65535;
    else if (e.keyCode == 89) fsw_state &= 32 ^ 65535;
    else if (e.keyCode == 85) fsw_state &= 64 ^ 65535;
    else if (e.keyCode == 73) fsw_state &= 128 ^ 65535;
    // ASDFGHJK for bottom row:
    else if (e.keyCode == 65) fsw_state &= 256 ^ 65535;
    else if (e.keyCode == 83) fsw_state &= 512 ^ 65535;
    else if (e.keyCode == 68) fsw_state &= 1024 ^ 65535;
    else if (e.keyCode == 70) fsw_state &= 2048 ^ 65535;
    else if (e.keyCode == 71) fsw_state &= 4096 ^ 65535;
    else if (e.keyCode == 72) fsw_state &= 8192 ^ 65535;
    else if (e.keyCode == 74) fsw_state &= 16384 ^ 65535;
    else if (e.keyCode == 75) fsw_state &= 32768 ^ 65535;
    else return true;

    e.preventDefault();
    return false;
}

// Document initialization:
function init() {
    window.requestAnimFrame = (function(){
      return  window.requestAnimationFrame       || 
              window.webkitRequestAnimationFrame || 
              window.mozRequestAnimationFrame    || 
              window.oRequestAnimationFrame      || 
              window.msRequestAnimationFrame     || 
              function(/* function */ callback, /* DOMElement */ element){
                window.setTimeout(callback, 1000 / 60);
              };
    })();

    document.addEventListener("keypress", function (e) { e.preventDefault(); return false; }, true);
    document.addEventListener("keydown", keydown, true);
    document.addEventListener("keyup", keyup, true);

    // Get canvas and its drawing context:
    cvs = document.getElementById('cvs');
    ctx = cvs.getContext('2d');

    cvs.setAttribute('width', inWidth * dpi);
    cvs.setAttribute('height', inHeight * dpi);

    // Initialize controller:
    eminorv2._controller_init();
    // Render UI:
    requestAnimFrame(renderUI);

    setInterval(function() {
        // Handle controller functions:
        eminorv2._controller_handle();

        // Update UI:
        if (ui_modified) {
            requestAnimFrame(renderUI);
            ui_modified = false;
        }
    }, 100);
}

document.addEventListener("DOMContentLoaded", init, false);
</script>
</body>
</html>